<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weather PWA</title>
<link rel="manifest" href="manifest.json">
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #121212;
        color: white;
        text-align: center;
        margin: 0;
        padding: 0;
    }
    .icon {
        width: 80px;
        margin-top: 20px;
    }
    .temperature {
        font-size: 48px;
        font-weight: bold;
        margin-top: 10px;
    }
    .humidity-aqi {
        font-size: 20px;
        margin-top: 8px;
    }
    .label-line {
        font-size: 14px;
        color: #bbb;
        display: flex;
        justify-content: center;
        gap: 40px;
        margin-top: -5px;
    }
    .updated {
        font-size: 14px;
        margin-top: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 5px;
    }
    button {
        padding: 10px 14px;
        margin: 3px;
        border: none;
        border-radius: 6px;
        background-color: #1e88e5;
        color: white;
        cursor: pointer;
        font-size: 18px;
    }
    .interval-controls {
        margin-top: 4px;
    }
    #location {
        font-size: 20px;
        margin-top: 6px;
    }
    footer {
        margin-top: 20px;
        font-size: 12px;
        color: #888;
    }
</style>
</head>
<body>

<img src="icons/thermometer.png" class="icon" alt="Thermometer">
<div id="location">Loading...</div>
<div class="temperature" id="temperature">--°C</div>

<div class="humidity-aqi">
    <span id="humidity">--%</span> | <span id="aqi">--</span>
</div>
<div class="label-line">
    <span>Humidity</span>
    <span>AQI</span>
</div>

<div class="updated">
    Updated: <span id="last-updated">--:--:--</span>
    <button id="refresh-btn">⟳</button>
</div>

<div class="interval-controls">
    Auto-refresh interval: <span id="interval-display">60</span>s
    <div>
        <button id="increase-interval">▲</button>
        <button id="decrease-interval">▼</button>
    </div>
</div>

<footer>APP-BY-JEET</footer>

<script>
const API_KEY = "679bddf7884949109fa193814251408";
let refreshInterval = 60;
let autoRefreshTimer;

function fetchWeather(lat, lon) {
    // Reverse geocoding for accurate location name
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
    .then(res => res.json())
    .then(locData => {
        let addr = locData.address;
        let name = addr.city || addr.town || addr.village || addr.hamlet || addr.suburb || addr.locality || addr.county || addr.state || "Unknown";
        let state = addr.state || "";
        document.getElementById('location').innerText = state && name !== state ? `${name}, ${state}` : name;
    })
    .catch(() => {
        document.getElementById('location').innerText = "Unknown Location";
    });

    // Weather API call
    fetch(`https://api.weatherapi.com/v1/current.json?key=${API_KEY}&q=${lat},${lon}&aqi=yes`)
    .then(response => response.json())
    .then(data => {
        document.getElementById('temperature').innerText = `${data.current.temp_c}°C`;
        document.getElementById('humidity').innerText = `${data.current.humidity}%`;
        document.getElementById('aqi').innerText = data.current.air_quality["pm2_5"] 
            ? Math.round(data.current.air_quality["pm2_5"]) 
            : "--";

        let now = new Date();
        document.getElementById('last-updated').innerText = now.toLocaleTimeString();
    })
    .catch(err => console.error(err));
}

function getLocationAndUpdate() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            pos => {
                fetchWeather(pos.coords.latitude, pos.coords.longitude);
            },
            err => {
                console.error(err);
                document.getElementById('location').innerText = "Location unavailable";
            }
        );
    } else {
        document.getElementById('location').innerText = "Geolocation not supported";
    }
}

document.getElementById('refresh-btn').addEventListener('click', getLocationAndUpdate);

document.getElementById('increase-interval').addEventListener('click', () => {
    refreshInterval += 10;
    document.getElementById('interval-display').innerText = refreshInterval;
    startAutoRefresh();
});
document.getElementById('decrease-interval').addEventListener('click', () => {
    if (refreshInterval > 10) {
        refreshInterval -= 10;
        document.getElementById('interval-display').innerText = refreshInterval;
        startAutoRefresh();
    }
});

function startAutoRefresh() {
    clearInterval(autoRefreshTimer);
    autoRefreshTimer = setInterval(getLocationAndUpdate, refreshInterval * 1000);
}

getLocationAndUpdate();
startAutoRefresh();
</script>
</body>
</html>
